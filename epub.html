<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EPUB.js</title>

  <script src="libs/jszip.min.js"></script>
  <script src="libs/epub.js"></script>

  <link rel="stylesheet" type="text/css" href="assets/epub.css">
</head>
<body>
  <div id="title"><input type="file" id="input"></div>
  <select id="toc"></select>
  <a id="prev" href="#prev" class="navlink">...</a>
  <div id="viewer" class="scrolled"></div>
  <div id="prev" class="arrow">‹</div>
  <div id="next" class="arrow">›</div>
  <a id="next" href="#next" class="navlink">...</a>

  <script>
  var book = ePub();
  var rendition, filename;
  var inputElement = document.getElementById("input");

  inputElement.addEventListener('change', function (e) {
    var file = e.target.files[0];
    filename = file.name;
    if (window.FileReader) {
        var reader = new FileReader();
        reader.onload = openBook;
        reader.readAsArrayBuffer(file);
        inputElement.remove()
    }
  });

  function openBook(e){
    var bookData = e.target.result;
    var title = document.getElementById("title");
    var next = document.getElementById("next");
    var prev = document.getElementById("prev");

    book.open(bookData, "binary");
    book.loaded.navigation.then(function(toc){

      var $select = document.getElementById("toc"),
          docfrag = document.createDocumentFragment();
      
      toc.forEach(function(chapter) {
        var option = document.createElement("option");
        option.textContent = chapter.label;
        option.ref = chapter.href;
        docfrag.appendChild(option);

        chapter.subitems.forEach(function(chp) {
          let option = document.createElement("option");
          option.textContent = "　" + chp.label;
          option.ref = chp.href;
          docfrag.appendChild(option);
        })
      });

      $select.appendChild(docfrag);

      $select.onchange = function(){
        var index = $select.selectedIndex,
            url = $select.options[index].ref;
        // currentSectionIndex = index;
        
        rendition.display(url)
        return false;
      };
    });

    rendition = book.renderTo("viewer", {
      flow: "scrolled-doc",
      width: "100%",
      height: "100%",
      fullsize: true,
    });

    var loc = localStorage.getItem(filename);
    if (loc !== null) {
      rendition.display(loc);
      localStorage.removeItem(filename)
    } else {
      rendition.display();      
    }
    // rendition.display();

    $select = document.getElementById("toc");

    var keyListener = function(e){
      if ((e.keyCode || e.which) == 37) {
        rendition.prev();
      }
      if ((e.keyCode || e.which) == 39) {
        rendition.next();
      }
      if ((e.keyCode || e.which) == 84) {
        var event = new MouseEvent('mousedown');
        $select.dispatchEvent(event);
      }
    };

    rendition.on("keyup", keyListener);
    // rendition.on("relocated", function(location){
    //   console.log(location);
    // });

    next.addEventListener("click", function(e){
        rendition.next();
    }, false);

    prev.addEventListener("click", function(e){
        rendition.prev();
    }, false);

    window.addEventListener('beforeunload', function (e) {
      localStorage.setItem(filename, rendition.location.start.cfi);
      e.returnValue = '';
    });

    rendition.themes.default({
      '*': {
        // 'background': 'rgb(32, 32, 32) !important', 
        'background': '#282923 !important', 
        'font-family': 'PingFangHK-Thin, sans-serif !important',
        //'text-align': 'justify !important',
        'line-height': '1.8em !important',
        // 'color': 'rgb(222, 222, 222) !important',
        'color': '#f8f8f2 !important',
        // 'font-size': '28px',
      }
    });

    let isMobile = window.matchMedia("only screen and (max-width: 760px)").matches;
    if (isMobile) {
      rendition.themes.fontSize("25px");
    } else {
      rendition.themes.fontSize("28px");
    }

    document.addEventListener("keyup", keyListener, false);
  }

  </script>

</body>
</html>
