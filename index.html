<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EPUB.js Input Example</title>
  <style type="text/css">
    body {
      margin: 0;
      /*background: rgb(32, 32, 32);*/
      background: #282923;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      /*color: rgb(222, 222, 222);*/
      color: #f8f8f2;
      position: absolute;
      height: 100%;
      width: 100%;
      min-height: 800px;
    }

    #title {
      width: 900px;
      min-height: 18px;
      margin: 10px auto;
      text-align: center;
      font-size: 16px;
      color: #E2E2E2;
      font-weight: 400;
    }

    #title:hover {
      color: #777;
    }

    #viewer.spreads {
      width: 900px;
      height: 600px;
      box-shadow: 0 0 4px #ccc;
      border-radius: 5px;
      padding: 0;
      position: relative;
      margin: 10px auto;
      background: white url('ajax-loader.gif') center center no-repeat;
      top: calc(50vh - 400px);
    }

    #viewer.spreads .epub-view > iframe {
        background: white;
    }

    #viewer.scrolled {
      overflow: hidden;
      width: 90%;
      margin: 0 auto;
      position: relative;
      background: url('ajax-loader.gif') center center no-repeat;
      /*box-shadow: 0 0 4px #ccc;*/
      padding: 20px;
      /*background: rgb(32, 32, 32);*/
      background: #282923;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    #viewer.scrolled .epub-view > iframe {
        background: white;
    }

    #prev {
      left: 0;
    }

    #next {
      right: 0;
    }

    #toc {
      display: block;
      margin: 10px auto;
    }

    @media (min-width: 1000px) {
      #viewer.spreads:after {
        position: absolute;
        width: 1px;
        border-right: 1px #000 solid;
        height: 90%;
        z-index: 1;
        left: 50%;
        margin-left: -1px;
        top: 5%;
        opacity: .15;
        box-shadow: -2px 0 15px rgba(0, 0, 0, 1);
        content:  "";
      }

      #viewer.spreads.single:after {
        display: none;
      }

      #prev {
        left: 40px;
      }

      #next {
        right: 40px;
      }
    }

    .arrow {
      position: fixed;
      top: 50%;
      margin-top: -32px;
      font-size: 64px;
      color: #E2E2E2;
      font-family: arial, sans-serif;
      font-weight: bold;
      cursor: pointer;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
      text-decoration: none;
    }

    .navlink {
      margin: 14px;
      display: block;
      text-align: center;
      text-decoration: none;
      color: #ccc;
    }

    .arrow:hover, .navlink:hover {
      color: #777;
    }

    .arrow:active, .navlink:hover {
      color: #000;
    }

    #book-wrapper {
      width: 480px;
      height: 640px;
      overflow: hidden;
      border: 1px solid #ccc;
      margin: 28px auto;
      background: #fff;
      border-radius: 0 5px 5px 0;
      position: absolute;
    }

    #book-viewer {
      width: 480px;
      height: 660px;
      margin: -30px auto;
      -moz-box-shadow:      inset 10px 0 20px rgba(0,0,0,.1);
      -webkit-box-shadow:   inset 10px 0 20px rgba(0,0,0,.1);
      box-shadow:           inset 10px 0 20px rgba(0,0,0,.1);
    }

    #book-viewer iframe {
      padding: 40px 40px;
    }

    #controls {
      position: absolute;
      bottom: 16px;
      left: 50%;
      width: 400px;
      margin-left: -200px;
      text-align: center;
      display: none;
    }

    #controls > input[type=range] {
        width: 400px;
    }

    #navigation {
      width: 400px;
      height: 100vh;
      position: absolute;
      overflow: auto;
      top: 0;
      left: 0;
      background: #777;
      -webkit-transition: -webkit-transform .25s ease-out;
      -moz-transition: -moz-transform .25s ease-out;
      -ms-transition: -moz-transform .25s ease-out;
      transition: transform .25s ease-out;

    }

    #navigation.fixed {
      position: fixed;
    }

    #navigation h1 {
      width: 200px;
      font-size: 16px;
      font-weight: normal;
      color: #fff;
      margin-bottom: 10px;
    }

    #navigation h2 {
      font-size: 14px;
      font-weight: normal;
      color: #B0B0B0;
      margin-bottom: 20px;
    }

    #navigation ul {
      padding-left: 36px;
      margin-left: 0;
      margin-top: 12px;
      margin-bottom: 12px;
      width: 340px;
    }

    #navigation ul li {
      list-style: decimal;
      margin-bottom: 10px;
      color: #cccddd;
      font-size: 12px;
      padding-left: 0;
      margin-left: 0;
    }

    #navigation ul li a {
      color: #ccc;
      text-decoration: none;
    }

    #navigation ul li a:hover {
      color: #fff;
      text-decoration: underline;
    }

    #navigation ul li a.active {
      color: #fff;
    }

    #navigation #cover {
      display: block;
      margin: 24px auto;
    }

    #navigation #closer {
      position: absolute;
      top: 0;
      right: 0;
      padding: 12px;
      color: #cccddd;
      width: 24px;
    }

    #navigation.closed {
      -webkit-transform: translate(-400px, 0);
      -moz-transform: translate(-400px, 0);
      -ms-transform: translate(-400px, 0);
      transform: translate(-400px, 0);
    }

    svg {
      display: block;
    }

    .close-x {
      stroke: #cccddd;
      fill: transparent;
      stroke-linecap: round;
      stroke-width: 5;
    }

    .close-x:hover {
      stroke: #fff;
    }

    #opener {
      position: absolute;
      top: 0;
      left: 0;
      padding: 10px;
      stroke: #E2E2E2;
      fill: #E2E2E2;

    }

    #opener:hover {
      stroke: #777;
      fill: #777;
    }

  </style>

  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>

</head>
<body>

  <div id="title"><input type="file" id="input"></div>
  <select id="toc"></select>
  <div id="viewer" class="scrolled"></div>
  <div id="prev" class="arrow">‹</div>
  <div id="next" class="arrow">›</div>

  <script>
  var book = ePub();
  var rendition;

  var inputElement = document.getElementById("input");

  inputElement.addEventListener('change', function (e) {
    var file = e.target.files[0];
    if (window.FileReader) {
        var reader = new FileReader();
        reader.onload = openBook;
        reader.readAsArrayBuffer(file);
    }
  });

  function openBook(e){
    var bookData = e.target.result;
    var title = document.getElementById("title");
    var next = document.getElementById("next");
    var prev = document.getElementById("prev");

    book.open(bookData, "binary");
    book.loaded.navigation.then(function(toc){

      var $select = document.getElementById("toc"),
          docfrag = document.createDocumentFragment();
      
      toc.forEach(function(chapter) {
        var option = document.createElement("option");
        option.textContent = chapter.label;
        option.ref = chapter.href;
        docfrag.appendChild(option);

        chapter.subitems.forEach(function(chp) {
          let option = document.createElement("option");
          option.textContent = "　" + chp.label;
          option.ref = chp.href;
          docfrag.appendChild(option);
        })
      });

      $select.appendChild(docfrag);

      $select.onchange = function(){
        var index = $select.selectedIndex,
            url = $select.options[index].ref;
        // currentSectionIndex = index;
        
        rendition.display(url)
        return false;
      };
    });

    rendition = book.renderTo("viewer", {
      flow: "scrolled-doc",
      width: "100%",
      height: "100%",
      fullsize: true,
    });

    rendition.display();

    $select = document.getElementById("toc");

    var keyListener = function(e){
      if ((e.keyCode || e.which) == 37) {
        rendition.prev();
      }
      if ((e.keyCode || e.which) == 39) {
        rendition.next();
      }
      if ((e.keyCode || e.which) == 84) {
        var event = new MouseEvent('mousedown');
        $select.dispatchEvent(event);
      }
    };

    rendition.on("keyup", keyListener);
    // rendition.on("relocated", function(location){
    //   console.log(location);
    // });

    next.addEventListener("click", function(e){
        rendition.next();
    }, false);

    prev.addEventListener("click", function(e){
        rendition.prev();
    }, false);
    
    rendition.themes.default({
      '*': {
        // 'background': 'rgb(32, 32, 32) !important', 
        'background': '#282923 !important', 
        'font-family': 'PingFangHK-Thin, sans-serif !important',
        //'text-align': 'justify !important',
        'line-height': '1.8em !important',
        // 'color': 'rgb(222, 222, 222) !important',
        'color': '#f8f8f2 !important',
        'font-size': '28px !important',
      }
    });

    document.addEventListener("keyup", keyListener, false);
  }

  </script>

</body>
</html>

